

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mindaffectBCI.decoder.decoder &mdash; mindaffectBCI - documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> mindaffectBCI
          

          
            
            <img src="../../../_static/MindAffect_Logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../OnlineBCI_quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">mindaffectBCI</a></li>
</ul>
<p class="caption"><span class="caption-text">The headset</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../printing_guide.html">Print Your Own Headset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fitting_guide.html">Setup &amp; fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../headset_layout.html">Headset layout</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mindaffectBCI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>mindaffectBCI.decoder.decoder</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mindaffectBCI.decoder.decoder</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.UtopiaDataInterface</span> <span class="kn">import</span> <span class="n">UtopiaDataInterface</span><span class="p">,</span> <span class="n">butterfilt_and_downsample</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.utopiaclient</span> <span class="kn">import</span> <span class="n">NewTarget</span><span class="p">,</span> <span class="n">Selection</span><span class="p">,</span> <span class="n">ModeChange</span><span class="p">,</span> <span class="n">PredictedTargetDist</span><span class="p">,</span> <span class="n">PredictedTargetProb</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.devent2stimsequence</span> <span class="kn">import</span> <span class="n">devent2stimSequence</span><span class="p">,</span> <span class="n">upsample_stimseq</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.model_fitting</span> <span class="kn">import</span> <span class="n">BaseSequence2Sequence</span><span class="p">,</span> <span class="n">MultiCCA</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.decodingSupervised</span> <span class="kn">import</span> <span class="n">decodingSupervised</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.decodingCurveSupervised</span> <span class="kn">import</span> <span class="n">decodingCurveSupervised</span><span class="p">,</span> <span class="n">plot_decoding_curve</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.scoreOutput</span> <span class="kn">import</span> <span class="n">dedupY0</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.updateSummaryStatistics</span> <span class="kn">import</span> <span class="n">updateSummaryStatistics</span><span class="p">,</span> <span class="n">plot_summary_statistics</span><span class="p">,</span> <span class="n">plot_erp</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">PREDICTIONPLOTS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">CALIBRATIONPLOTS</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="get_trial_start_end"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.decoder.get_trial_start_end">[docs]</a><span class="k">def</span> <span class="nf">get_trial_start_end</span><span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">start_ts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;get the start+end times of the trials in a utopia message stream&#39;&#39;&#39;</span>
    <span class="n">trials</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">keeplast</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">mi</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">msgs</span><span class="p">):</span>
        <span class="c1">#print(&quot;msg={}&quot;.format(m))</span>
        <span class="c1"># process begin trail messages, N.B. after end-trial!</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">msgID</span> <span class="o">==</span> <span class="n">NewTarget</span><span class="o">.</span><span class="n">msgID</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start_ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">start_ts</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NT: tr-bgn=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_ts</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># treat as end of sequence + start next sequence</span>
                <span class="n">trials</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_ts</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
                <span class="n">start_ts</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NT: tr-end=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NT: tr-bgn=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
            
        <span class="c1"># process the end-trial messages</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">msgID</span> <span class="o">==</span> <span class="n">Selection</span><span class="o">.</span><span class="n">msgID</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trials</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_ts</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
                <span class="n">start_ts</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SL: tr-end=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selection without start&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">msgID</span> <span class="o">==</span> <span class="n">ModeChange</span><span class="o">.</span><span class="n">msgID</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trials</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_ts</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
                <span class="n">start_ts</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">timestamp</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MC: tr-end=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mod-chg=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
            <span class="c1"># mark this message a *not* processed so it gets to the main loop</span>
            <span class="n">keeplast</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">break</span>
    <span class="c1"># make list un-processed messages</span>
    <span class="k">if</span> <span class="n">msgs</span> <span class="ow">and</span> <span class="n">keeplast</span><span class="p">:</span>
        <span class="n">msgs</span> <span class="o">=</span> <span class="n">msgs</span><span class="p">[</span><span class="n">mi</span><span class="p">:]</span>
        <span class="c1">#print(&quot;unproc messages: {}&quot;.format(msgs))</span>
    <span class="c1"># return trial start/end + non-processed messages</span>
    <span class="c1"># N.B. start_ts is not None if trail start without end..</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">start_ts</span><span class="p">,</span> <span class="n">msgs</span><span class="p">)</span></div>

<div class="viewcode-block" id="getCalibration_dataset"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.decoder.getCalibration_dataset">[docs]</a><span class="k">def</span> <span class="nf">getCalibration_dataset</span><span class="p">(</span><span class="n">ui</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; extract a labelled dataset from the utopiaInterface, which are trilas between modechange messages &#39;&#39;&#39;</span>
    <span class="c1"># run until we get a mode change gathering training data in trials</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start_ts</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">isCalibrating</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">isCalibrating</span><span class="p">:</span>

        <span class="c1"># get new messages from utopia-hub</span>
        <span class="n">newmsgs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="c1">#  print(&quot;Extact_msgs:&quot;); print(&quot;{}&quot;.format(newmsgs))</span>

        <span class="c1"># incremental extract trial limits</span>
        <span class="n">trials</span><span class="p">,</span> <span class="n">start_ts</span><span class="p">,</span> <span class="n">newmsgs</span> <span class="o">=</span> <span class="n">get_trial_start_end</span><span class="p">(</span><span class="n">newmsgs</span><span class="p">,</span> <span class="n">start_ts</span><span class="p">)</span>

        <span class="c1"># extract any complete trials data/msgs</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">bgn_ts</span><span class="p">,</span> <span class="n">end_ts</span><span class="p">)</span> <span class="ow">in</span> <span class="n">trials</span><span class="p">:</span>
            <span class="c1"># N.B. be sure to make a copy so isn&#39;t changed outside us..</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">extract_data_segment</span><span class="p">(</span><span class="n">bgn_ts</span><span class="p">,</span> <span class="n">end_ts</span><span class="p">)</span>
            <span class="n">stimulus</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">extract_stimulus_segment</span><span class="p">(</span><span class="n">bgn_ts</span><span class="p">,</span> <span class="n">end_ts</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extract trl: </span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">: data=</span><span class="si">{}</span><span class="s2"> stim=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bgn_ts</span><span class="p">,</span> <span class="n">end_ts</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">stimulus</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">stimulus</span><span class="p">))</span>

        <span class="c1"># check for end-calibration messages</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newmsgs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">msgID</span> <span class="o">==</span> <span class="n">ModeChange</span><span class="o">.</span><span class="n">msgID</span><span class="p">:</span>
                <span class="n">isCalibrating</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># return unprocessed messages including the mode change</span>
                <span class="c1">#  print(&#39;cal pushback: {}&#39;.format(newmsgs[i:]))</span>
                <span class="n">ui</span><span class="o">.</span><span class="n">push_back_newmsgs</span><span class="p">(</span><span class="n">newmsgs</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">dataset</span></div>

<div class="viewcode-block" id="dataset_to_XY_ndarrays"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.decoder.dataset_to_XY_ndarrays">[docs]</a><span class="k">def</span> <span class="nf">dataset_to_XY_ndarrays</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; convert variable-trial length dataset with stimulus information to fixed size sklearn compatiable (X,Y) nd-arrays&#39;&#39;&#39;</span>
    <span class="c1"># get length of each trial</span>
    <span class="n">trlen</span> <span class="o">=</span> <span class="p">[</span><span class="n">trl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">trl</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>
    <span class="n">trstim</span> <span class="o">=</span> <span class="p">[</span><span class="n">trl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">trl</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trlen: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trlen</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trstim: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trstim</span><span class="p">))</span>
    <span class="c1"># set array trial length to 90th percential length</span>
    <span class="n">trlen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">trlen</span><span class="p">,</span> <span class="mi">90</span><span class="p">))</span>
    <span class="n">trstim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">trstim</span><span class="p">,</span> <span class="mi">90</span><span class="p">)))</span>
    <span class="c1"># filter the trials to only be the  ones long enough to be worth processing</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">trlen</span><span class="o">//</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">trstim</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">trlen</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># map to single fixed size matrix + upsample stimulus to he EEG sample rate</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">trlen</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">trlen</span><span class="p">,</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># zero-padded data, w/o time-stamps</span>
    <span class="n">X_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span><span class="n">trlen</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">Y_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span><span class="n">trlen</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">stimulus</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
        <span class="c1"># extract the data &amp; remove the timestamp channel and insert into the ndarray</span>
        <span class="c1"># guard for slightly different sizes..</span>
        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">X</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">X_ts</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pad end with final value</span>
            <span class="n">X</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">X</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">X_ts</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># upsample stimulus to the data-sample rate and insert into ndarray</span>
        <span class="n">data_ts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># data timestamp per sample</span>
        <span class="n">stimulus_ts</span> <span class="o">=</span> <span class="n">stimulus</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># stimulus timestamp per stimulus event</span>
        <span class="n">stimulus</span><span class="p">,</span> <span class="n">data_i</span> <span class="o">=</span> <span class="n">upsample_stimseq</span><span class="p">(</span><span class="n">data_ts</span><span class="p">,</span> <span class="n">stimulus</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">stimulus_ts</span><span class="p">)</span>
        <span class="c1"># store -- compensating for any variable trial lengths.</span>
        <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stimulus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># long trial</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stimulus</span><span class="p">[:</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># short trial</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="p">:</span><span class="n">stimulus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stimulus</span>
        <span class="c1"># record stim-ts @ this data_ts</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">data_i</span> <span class="o">&lt;</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Y_ts</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span><span class="n">data_i</span><span class="p">[</span><span class="n">tmp</span><span class="p">]]</span> <span class="o">=</span> <span class="n">stimulus_ts</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> 

    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_ts</span><span class="p">,</span> <span class="n">Y_ts</span></div>


<div class="viewcode-block" id="strip_unused"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.decoder.strip_unused">[docs]</a><span class="k">def</span> <span class="nf">strip_unused</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span>
    <span class="c1"># strip unused outputs</span>
    <span class="n">used_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">used_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># ensure objID=0 is always used..</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">used_y</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Y</span><span class="p">,</span> <span class="n">used_y</span></div>


<div class="viewcode-block" id="doCalibrationSupervised"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.decoder.doCalibrationSupervised">[docs]</a><span class="k">def</span> <span class="nf">doCalibrationSupervised</span><span class="p">(</span><span class="n">ui</span><span class="p">:</span> <span class="n">UtopiaDataInterface</span><span class="p">,</span> <span class="n">clsfr</span><span class="p">:</span> <span class="n">BaseSequence2Sequence</span><span class="p">,</span> 
                            <span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">calfn</span><span class="o">=</span><span class="s2">&quot;calibration_data.pk&quot;</span><span class="p">,</span> <span class="n">fitfn</span><span class="o">=</span><span class="s2">&quot;fit_data.pk&quot;</span><span class="p">,</span> <span class="n">previous_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; do a calibration phase = basically just extract  the training data and train a classifier from the utopiaInterface&#39;&#39;&#39;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">getCalibration_dataset</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">previous_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># combine with the old calibration data</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">previous_dataset</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="c1"># convert msgs -&gt; to nd-arrays</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_ts</span><span class="p">,</span> <span class="n">Y_ts</span> <span class="o">=</span> <span class="n">dataset_to_XY_ndarrays</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pickle</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span> <span class="n">X_ts</span><span class="o">=</span><span class="n">X_ts</span><span class="p">,</span> <span class="n">Y_ts</span><span class="o">=</span><span class="n">Y_ts</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">ui</span><span class="o">.</span><span class="n">fs</span><span class="p">),</span>
                        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;calibration_data.pk&#39;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error saving cal data&#39;</span><span class="p">)</span>

        <span class="c1"># guard against empty training dataset</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">Y</span><span class="p">,</span> <span class="n">used_idx</span> <span class="o">=</span> <span class="n">strip_unused</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        
        <span class="c1"># now call the clsfr fit method, on the true-target info</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training dataset = (</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">cvscores</span> <span class="o">=</span> <span class="n">clsfr</span><span class="o">.</span><span class="n">cv_fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cvscores</span><span class="p">[</span><span class="s1">&#39;test_score&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;clsfr=</span><span class="si">{}</span><span class="s2"> =&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clsfr</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">decoding_curve</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">cvscores</span><span class="p">[</span><span class="s1">&#39;estimator&#39;</span><span class="p">],</span> <span class="n">nInt</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                                      <span class="n">priorsigma</span><span class="o">=</span><span class="p">(</span><span class="n">clsfr</span><span class="o">.</span><span class="n">sigma0_</span><span class="p">,</span> <span class="n">clsfr</span><span class="o">.</span><span class="n">priorweight</span><span class="p">),</span>
                                      <span class="n">softmaxscale</span><span class="o">=</span><span class="n">clsfr</span><span class="o">.</span><span class="n">softmaxscale_</span><span class="p">)</span>
        <span class="c1"># extract the final estimated performance</span>
        <span class="c1">#print(&quot;decoding curve {}&quot;.format(decoding_curve[1]))</span>
        <span class="c1">#print(&quot;score {}&quot;.format(score))</span>
        <span class="n">perr</span> <span class="o">=</span> <span class="n">decoding_curve</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">decoding_curve</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span><span class="o">-</span><span class="n">score</span>
        <span class="k">if</span> <span class="n">CALIBRATIONPLOTS</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
            <span class="c1">#if True:</span>
                <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">clsfr</span><span class="o">.</span><span class="n">plot_model</span><span class="p">(</span><span class="n">fs</span><span class="o">=</span><span class="n">ui</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Factored Model&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">plot_decoding_curve</span><span class="p">(</span><span class="o">*</span><span class="n">decoding_curve</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Decoding Curve&#39;</span><span class="p">)</span>
                <span class="c1">#  from analyse_datasets import debug_test_dataset</span>
                <span class="c1">#  debug_test_dataset(X,Y,None,fs=ui.fs)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># plot the CCA info</span>
                <span class="n">Y_true</span> <span class="o">=</span> <span class="n">clsfr</span><span class="o">.</span><span class="n">stim2event</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
                <span class="n">Y_true</span> <span class="o">=</span> <span class="n">Y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,:]</span>
                <span class="n">Cxx</span><span class="p">,</span> <span class="n">Cxy</span><span class="p">,</span> <span class="n">Cyy</span> <span class="o">=</span> <span class="n">updateSummaryStatistics</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y_true</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="n">clsfr</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
                <span class="n">plot_summary_statistics</span><span class="p">(</span><span class="n">Cxx</span><span class="p">,</span><span class="n">Cxy</span><span class="p">,</span><span class="n">Cyy</span><span class="p">,</span><span class="n">clsfr</span><span class="o">.</span><span class="n">evtlabs</span><span class="p">,</span><span class="n">fs</span><span class="o">=</span><span class="n">ui</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Summary Statistics&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">pickle</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">Cxx</span><span class="o">=</span><span class="n">Cxx</span><span class="p">,</span> <span class="n">Cxy</span><span class="o">=</span><span class="n">Cxy</span><span class="p">,</span> <span class="n">Cyy</span><span class="o">=</span><span class="n">Cyy</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">clsfr</span><span class="o">.</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">ui</span><span class="o">.</span><span class="n">fs</span><span class="p">),</span>
                                <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;summary_statistics.pk&#39;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error saving cal data&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">plot_erp</span><span class="p">(</span><span class="n">Cxy</span><span class="p">,</span><span class="n">evtlabs</span><span class="o">=</span><span class="n">clsfr</span><span class="o">.</span><span class="n">evtlabs</span><span class="p">,</span><span class="n">fs</span><span class="o">=</span><span class="n">ui</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Event Related Potential (ERP)&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># save figures</span>
                <span class="n">logsdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span><span class="s1">&#39;../../logs/&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logsdir</span><span class="p">,</span><span class="s1">&#39;model_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uname</span><span class="p">)))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logsdir</span><span class="p">,</span><span class="s1">&#39;decoding_curve_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uname</span><span class="p">)))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logsdir</span><span class="p">,</span><span class="s1">&#39;summary_statistics_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uname</span><span class="p">)))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logsdir</span><span class="p">,</span><span class="s1">&#39;erp_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uname</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># send message with calibration performance score</span>
        <span class="n">ui</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">PredictedTargetProb</span><span class="p">(</span><span class="n">ui</span><span class="o">.</span><span class="n">stimulus_timestamp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">perr</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span></div>


<div class="viewcode-block" id="doPrediction"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.decoder.doPrediction">[docs]</a><span class="k">def</span> <span class="nf">doPrediction</span><span class="p">(</span><span class="n">clsfr</span><span class="p">:</span> <span class="n">BaseSequence2Sequence</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">stimulus</span><span class="p">,</span> <span class="n">prev_stimulus</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; given the current trials data, apply the classifier and decoder to make target predictions &#39;&#39;&#39;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">X_ts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">stimulus</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Y_ts</span> <span class="o">=</span> <span class="n">stimulus</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">X_ts</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">Y_ts</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># fast path empty inputs</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># strip outputs that we don&#39;t use, to save compute time</span>
    <span class="n">Y</span><span class="p">,</span> <span class="n">used_idx</span> <span class="o">=</span> <span class="n">strip_unused</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="c1"># strip the true target info if it&#39;s a copy, so it doesn&#39;t mess up Py computation</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">dedupY0</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">zerodup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">yfeatdim</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># up-sample Y to the match the rate of X</span>
    <span class="c1"># TODO[]: should this happen in the data-interface?</span>
    <span class="n">Y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">upsample_stimseq</span><span class="p">(</span><span class="n">X_ts</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Y_ts</span><span class="p">)</span>
    <span class="c1"># predict on X,Y without the time-stamp info</span>
    <span class="n">Fy_1</span> <span class="o">=</span> <span class="n">clsfr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">prevY</span><span class="o">=</span><span class="n">prev_stimulus</span><span class="p">)</span>
    <span class="c1"># map-back to 256</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Fy_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">256</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="n">Fy_1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">Fy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">used_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fy_1</span>
    <span class="k">return</span> <span class="n">Fy</span></div>


<div class="viewcode-block" id="combine_Ptgt"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.decoder.combine_Ptgt">[docs]</a><span class="k">def</span> <span class="nf">combine_Ptgt</span><span class="p">(</span><span class="n">pvals_objIDs</span><span class="p">):</span>
    <span class="n">pvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pvals_objIDs</span><span class="p">]</span> 
    <span class="n">objIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pvals_objIDs</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isequal</span><span class="p">(</span><span class="n">objIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">oi</span><span class="p">)</span> <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">objIDs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning combination only supported for fixed output set currently!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pvals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">objIDs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>  <span class="c1"># (nBlk,nObj)</span>
    <span class="c1"># coorected combination</span>
    <span class="n">Ptgt</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pvals</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pvals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">Ptgt</span><span class="p">,</span> <span class="n">objIDs</span></div>


<div class="viewcode-block" id="send_prediction"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.decoder.send_prediction">[docs]</a><span class="k">def</span> <span class="nf">send_prediction</span><span class="p">(</span><span class="n">ui</span><span class="p">:</span> <span class="n">UtopiaDataInterface</span><span class="p">,</span> <span class="n">Ptgt</span><span class="p">,</span> <span class="n">used_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1">#print(&quot; Pred= used_idx:{} ptgt:{}&quot;.format(used_idx,Ptgt))</span>
    <span class="c1"># N.B. for network efficiency, only send for non-zero probability outputs</span>
    <span class="n">nonzero_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">Ptgt</span><span class="p">)</span>
    <span class="c1"># ensure a least one entry</span>
    <span class="k">if</span> <span class="n">nonzero_idx</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="n">nonzero_idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Ptgt</span> <span class="o">=</span> <span class="n">Ptgt</span><span class="p">[</span><span class="n">nonzero_idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">used_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">used_idx</span> <span class="o">=</span> <span class="n">nonzero_idx</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">used_idx</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">):</span> <span class="c1"># logical-&gt;index</span>
            <span class="n">used_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">used_idx</span><span class="p">)</span>
        <span class="n">used_idx</span> <span class="o">=</span> <span class="n">used_idx</span><span class="p">[</span><span class="n">nonzero_idx</span><span class="p">]</span>
    <span class="c1">#  print(&quot; Pred= used_idx:{} ptgt:{}&quot;.format(used_idx,Ptgt))</span>
    <span class="c1"># send the prediction messages, PredictedTargetProb, PredictedTargetDist</span>
    <span class="n">y_est_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Ptgt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># most likely target and the chance that it is wrong</span>
    <span class="k">if</span> <span class="n">Ptgt</span><span class="p">[</span><span class="n">y_est_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;P==1?&quot;</span><span class="p">)</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ptp</span> <span class="o">=</span> <span class="n">PredictedTargetProb</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">used_idx</span><span class="p">[</span><span class="n">y_est_idx</span><span class="p">],</span> <span class="mi">1</span><span class="o">-</span><span class="n">Ptgt</span><span class="p">[</span><span class="n">y_est_idx</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Pred= </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ptp</span><span class="p">))</span>
        <span class="n">ui</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">ptp</span><span class="p">)</span>
    <span class="c1"># distribution over all *non-zero* targets</span>
    <span class="n">ui</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">PredictedTargetDist</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">used_idx</span><span class="p">,</span> <span class="n">Ptgt</span><span class="p">))</span></div>
    

<div class="viewcode-block" id="doPredictionStatic"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.decoder.doPredictionStatic">[docs]</a><span class="k">def</span> <span class="nf">doPredictionStatic</span><span class="p">(</span><span class="n">ui</span><span class="p">:</span> <span class="n">UtopiaDataInterface</span><span class="p">,</span> <span class="n">clsfr</span><span class="p">:</span> <span class="n">BaseSequence2Sequence</span><span class="p">,</span> <span class="n">model_apply_type</span><span class="o">=</span><span class="s1">&#39;trial&#39;</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">block_step_ms</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">maxDecisLen_ms</span><span class="o">=</span><span class="mi">8000</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; do the prediction stage = basically extract data/msgs from trial start and generate a prediction from them &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">clsfr</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: trying to predict without training classifier!&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># TODO []: Block based prediction is slightly slower?  Why?</span>
    <span class="k">if</span> <span class="n">timeout_ms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">timeout_ms</span> <span class="o">=</span> <span class="n">block_step_ms</span>
    
    <span class="c1"># start of the data block to apply the model to</span>
    <span class="n">block_start_ts</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">data_timestamp</span>
    <span class="n">overlap_samp</span> <span class="o">=</span> <span class="n">clsfr</span><span class="o">.</span><span class="n">tau</span>
    <span class="n">overlap_ms</span> <span class="o">=</span> <span class="n">overlap_samp</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">ui</span><span class="o">.</span><span class="n">fs</span>
    <span class="n">maxDecisLen_samp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxDecisLen_ms</span> <span class="o">*</span> <span class="n">ui</span><span class="o">.</span><span class="n">fs</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># (1,nSamp,nY):float score for each output for each sample</span>
    <span class="n">trial_start_ts</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">isPredicting</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># run until we get a mode change gathering training data in trials</span>
    <span class="k">while</span> <span class="n">isPredicting</span><span class="p">:</span>
        <span class="c1"># get new messages from utopia-hub</span>
        <span class="n">newmsgs</span><span class="p">,</span> <span class="n">ndata</span><span class="p">,</span> <span class="n">nstim</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">timeout_ms</span><span class="o">=</span><span class="n">timeout_ms</span><span class="p">,</span><span class="n">mintime_ms</span><span class="o">=</span><span class="n">timeout_ms</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># TODO[]: Fix to not re-process the same data if no new stim to be processed..</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newmsgs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nstim</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ndata</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># get the timestamp for the last data which it is valid to apply the model to,</span>
        <span class="c1"># that is where have enough data to include a complete response for this stimulus</span>
        <span class="c1"># Note: can&#39;t just use last data, incase stimuli are lagged w.r.t. data</span>
        <span class="c1"># also, prevents processing data for which are not stimulus events to compare with</span>
        <span class="n">valid_end_ts</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ui</span><span class="o">.</span><span class="n">stimulus_timestamp</span> <span class="o">+</span> <span class="n">overlap_ms</span><span class="p">,</span> <span class="n">ui</span><span class="o">.</span><span class="n">data_timestamp</span><span class="p">)</span>

        <span class="c1"># incremental extract trial limits</span>
        <span class="n">otrial_start_ts</span> <span class="o">=</span> <span class="n">trial_start_ts</span>
        <span class="n">trials</span><span class="p">,</span> <span class="n">trial_start_ts</span><span class="p">,</span> <span class="n">newmsgs</span> <span class="o">=</span> <span class="n">get_trial_start_end</span><span class="p">(</span><span class="n">newmsgs</span><span class="p">,</span> <span class="n">trial_start_ts</span><span class="p">)</span>

        <span class="c1"># change in trial-start -&gt; end-of-trial / start new trial detected</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trial_start_ts</span> <span class="o">==</span> <span class="n">otrial_start_ts</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;New trial! tr_start=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trial_start_ts</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">PREDICTIONPLOTS</span> <span class="ow">and</span> <span class="n">Fy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fy=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Fy</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">Fy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">Fy</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">block_start_ts</span> <span class="o">=</span> <span class="n">trial_start_ts</span>

        <span class="c1"># compute the start/end of the segement to apply the model to</span>
        <span class="k">if</span> <span class="n">model_apply_type</span> <span class="o">==</span> <span class="s1">&#39;trial&#39;</span><span class="p">:</span>
            <span class="c1"># apply the model to all available data from trial start</span>
            <span class="n">block_start_ts</span> <span class="o">=</span> <span class="n">trial_start_ts</span>
            <span class="k">if</span> <span class="n">block_start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">block_start_ts</span> <span class="o">+</span> <span class="n">block_step_ms</span> <span class="o">+</span> <span class="n">overlap_ms</span> <span class="o">&lt;</span> <span class="n">valid_end_ts</span><span class="p">:</span>
                <span class="n">block_end_ts</span> <span class="o">=</span> <span class="n">valid_end_ts</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">block_end_ts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># limit the trial size</span>
            <span class="k">if</span> <span class="n">block_start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">block_start_ts</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="n">block_start_ts</span><span class="p">,</span> <span class="n">valid_end_ts</span> <span class="o">-</span> <span class="n">maxDecisLen_ms</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check if enough data to apply the model</span>
            <span class="k">if</span> <span class="n">block_start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">block_start_ts</span> <span class="o">+</span> <span class="n">block_step_ms</span> <span class="o">+</span> <span class="n">overlap_ms</span> <span class="o">&lt;</span> <span class="n">valid_end_ts</span><span class="p">:</span>
                <span class="c1"># got enough data to process this block</span>
                <span class="n">block_end_ts</span> <span class="o">=</span> <span class="n">valid_end_ts</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># not enough yet -&gt; clear the end to indicate dont apply the model</span>
                <span class="n">block_end_ts</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># if we have a valid block to apply the model do</span>
        <span class="k">if</span> <span class="n">block_start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">block_end_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># extract and apply to this block</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extract block: </span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">ms&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">block_start_ts</span><span class="p">,</span> <span class="n">block_end_ts</span><span class="p">,</span> <span class="n">block_end_ts</span><span class="o">-</span><span class="n">block_start_ts</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">extract_data_segment</span><span class="p">(</span><span class="n">block_start_ts</span><span class="p">,</span> <span class="n">block_end_ts</span><span class="p">)</span>
            <span class="n">stimulus</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">extract_stimulus_segment</span><span class="p">(</span><span class="n">block_start_ts</span><span class="p">,</span> <span class="n">block_end_ts</span><span class="p">)</span>
            <span class="c1"># skip if no data/stimulus to process</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">stimulus</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got: data </span><span class="si">{}</span><span class="s1">-&gt;</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)  stimulus </span><span class="si">{}</span><span class="s1">-&gt;</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">&gt;0)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                              <span class="n">stimulus</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">stimulus</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stimulus</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">if</span> <span class="n">model_apply_type</span> <span class="o">==</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span>
                <span class="c1"># update the start point for the next block</span>
                <span class="c1"># start next block at overlap before the end of this blocks data</span>
                <span class="c1"># so have sample accurate predictions, with no missing data, and no overlaps</span>
                <span class="n">block_start_ts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="n">overlap_samp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># ~= block_end_ts - overlap_ms +1-sample</span>
                <span class="n">bend</span> <span class="o">=</span> <span class="n">block_start_ts</span> <span class="o">+</span> <span class="n">block_step_ms</span> <span class="o">+</span> <span class="n">overlap_ms</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;next block </span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">: in </span><span class="si">{}</span><span class="s2">ms&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">block_start_ts</span><span class="p">,</span> <span class="n">bend</span><span class="p">,</span> <span class="n">bend</span> <span class="o">-</span> <span class="n">ui</span><span class="o">.</span><span class="n">data_timestamp</span><span class="p">))</span>

            <span class="c1"># get predictions for this data block</span>
            <span class="n">block_Fy</span> <span class="o">=</span> <span class="n">doPrediction</span><span class="p">(</span><span class="n">clsfr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">stimulus</span><span class="p">)</span>
            <span class="c1"># strip predictions from the overlap period</span>
            <span class="n">block_Fy</span> <span class="o">=</span> <span class="n">block_Fy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="n">overlap_samp</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># if got valid predictions...</span>
            <span class="k">if</span> <span class="n">block_Fy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># accumulate or store the predictions</span>
                <span class="k">if</span> <span class="n">model_apply_type</span> <span class="o">==</span> <span class="s1">&#39;trial&#39;</span><span class="p">:</span>
                    <span class="n">Fy</span> <span class="o">=</span> <span class="n">block_Fy</span>
                <span class="k">elif</span> <span class="n">model_apply_type</span> <span class="o">==</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span>  <span class="c1"># accumulate blocks in the trial</span>
                    <span class="k">if</span> <span class="n">Fy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># restart accumulation</span>
                        <span class="n">Fy</span> <span class="o">=</span> <span class="n">block_Fy</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Fy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Fy</span><span class="p">,</span> <span class="n">block_Fy</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># limit the trial length</span>
                <span class="k">if</span> <span class="n">maxDecisLen_ms</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Fy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxDecisLen_samp</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;limit trial length </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Fy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">maxDecisLen_samp</span><span class="p">))</span>
                    <span class="n">Fy</span> <span class="o">=</span> <span class="n">Fy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="n">maxDecisLen_samp</span><span class="p">:,</span> <span class="p">:]</span>

                <span class="c1"># send prediction event</span>
                <span class="c1"># only process the used-subset</span>
                <span class="n">used_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">Fy</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Fy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">used_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># force include 0</span>
                <span class="c1"># map to probabilities, including the prior over sigma!</span>
                <span class="n">Ptgt</span> <span class="o">=</span> <span class="n">clsfr</span><span class="o">.</span><span class="n">decode_proba</span><span class="p">(</span><span class="n">Fy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">used_idx</span><span class="p">])</span>
                <span class="c1">#  _, _, Ptgt, _, _ = decodingSupervised(Fy[...,used_idx])</span>
                <span class="c1"># BODGE: only  use the last (most data?) prediction...</span>
                <span class="n">Ptgt</span> <span class="o">=</span> <span class="n">Ptgt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="c1"># send prediction with last recieved stimulus_event timestamp</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fy=</span><span class="si">{}</span><span class="s2"> Yest=</span><span class="si">{}</span><span class="s2"> Perr=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Fy</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Ptgt</span><span class="p">),</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Ptgt</span><span class="p">)))</span>

                <span class="n">send_prediction</span><span class="p">(</span><span class="n">ui</span><span class="p">,</span> <span class="n">Ptgt</span><span class="p">,</span> <span class="n">used_idx</span><span class="o">=</span><span class="n">used_idx</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">ui</span><span class="o">.</span><span class="n">stimulus_timestamp</span><span class="p">)</span>
            
        <span class="c1"># check for end-prediction messages</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newmsgs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">msgID</span> <span class="o">==</span> <span class="n">ModeChange</span><span class="o">.</span><span class="n">msgID</span><span class="p">:</span>
                <span class="n">isPredicting</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># return unprocessed messages to stack. Q: why i+1?</span>
                <span class="n">ui</span><span class="o">.</span><span class="n">push_back_newmsgs</span><span class="p">(</span><span class="n">newmsgs</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span></div>

<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.decoder.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">ui</span><span class="p">:</span> <span class="n">UtopiaDataInterface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clsfr</span><span class="p">:</span> <span class="n">BaseSequence2Sequence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg_timeout_ms</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
        <span class="n">host</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datafile</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tau_ms</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mi">450</span><span class="p">,</span> <span class="n">offset_ms</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_fs</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">stopband</span><span class="o">=</span><span class="p">((</span><span class="mi">45</span><span class="p">,</span><span class="mi">65</span><span class="p">),(</span><span class="mf">5.5</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="s1">&#39;bandpass&#39;</span><span class="p">)),</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;butter&#39;</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">cv</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
        <span class="n">calplots</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">predplots</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; run the main decoder processing loop</span>

<span class="sd">    Args:</span>
<span class="sd">        ui (UtopiaDataInterface, optional): The utopia data interface class. Defaults to None.</span>
<span class="sd">        clsfr (BaseSequence2Sequence, optional): the classifer to use when model fitting. Defaults to None.</span>
<span class="sd">        msg_timeout_ms (float, optional): timeout for getting new messages from the data-interface. Defaults to 100.</span>
<span class="sd">        host (str, optional): hostname for the utopia hub. Defaults to None.</span>
<span class="sd">        tau_ms (float, optional): length of the stimulus response. Defaults to 400.</span>
<span class="sd">        offset_ms (float, optiona): offset in ms to shift the analysis window. Use to compensate for response lag.  Defaults to 0.</span>
<span class="sd">        stopband (tuple, optional): temporal filter specification for `UtopiaDataInterface.butterfilt_and_downsample`. Defaults to ((45,65),(5.5,25,&#39;bandpass&#39;))</span>
<span class="sd">        ftype (str, optional): type of temporal filter to use.  Defaults to &#39;butter&#39;.</span>
<span class="sd">        order (int, optional): order of temporal filter to use.  Defaults to 6.</span>
<span class="sd">        out_fs (float, optional): sample rate after the pre-processor. Defaults to 100.</span>
<span class="sd">        evtlabs (tuple, optional): the brain event coding to use.  Defaults to None.</span>
<span class="sd">        calplots (bool, optional): flag if we make plots after calibration. Defaults to False.</span>
<span class="sd">        predplots (bool, optional): flag if we make plots after each prediction trial. Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">CALIBRATIONPLOTS</span><span class="p">,</span> <span class="n">PREDICTIONPLOTS</span>
    <span class="n">CALIBRATIONPLOTS</span> <span class="o">=</span> <span class="n">calplots</span>
    <span class="n">PREDICTIONPLOTS</span> <span class="o">=</span> <span class="n">predplots</span>
    <span class="k">try</span> <span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">guiplots</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">guiplots</span><span class="o">=</span><span class="kc">False</span>

    <span class="c1"># setup the saving label</span>
    <span class="k">global</span> <span class="n">uname</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> 
    <span class="n">uname</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y%m</span><span class="si">%d</span><span class="s2">_%H%M&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># include label as prefix</span>
        <span class="n">uname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">uname</span><span class="p">)</span>

    <span class="c1"># create data interface with bandpass and downsampling pre-processor, running about 10hz updates</span>
    <span class="k">if</span> <span class="n">ui</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ppfn</span> <span class="o">=</span> <span class="n">butterfilt_and_downsample</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">stopband</span><span class="o">=</span><span class="n">stopband</span><span class="p">,</span> <span class="n">fs_out</span><span class="o">=</span><span class="n">out_fs</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="n">ftype</span><span class="p">)</span>
        <span class="c1">#ppfn = butterfilt_and_downsample(order=4, stopband=&#39;butter_stopband((0, 5), (25, -1))_fs200.pk&#39;, fs_out=out_fs)</span>
        <span class="c1">#ppfn = None</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">UtopiaDataInterface</span><span class="p">(</span><span class="n">data_preprocessor</span><span class="o">=</span><span class="n">ppfn</span><span class="p">,</span>
                                 <span class="n">stimulus_preprocessor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">timeout_ms</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mintime_ms</span><span class="o">=</span><span class="mi">55</span><span class="p">)</span> <span class="c1"># 20hz updates</span>
    <span class="n">ui</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">queryifhostnotfound</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># use a multi-cca for the model-fitting</span>
    <span class="k">if</span> <span class="n">clsfr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evtlabs</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span> <span class="c1"># decode string coded spec</span>
            <span class="n">evtlabs</span> <span class="o">=</span> <span class="n">evtlabs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">clsfr</span> <span class="o">=</span> <span class="n">MultiCCA</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">out_fs</span><span class="o">*</span><span class="n">tau_ms</span><span class="o">/</span><span class="mi">1000</span><span class="p">),</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">out_fs</span><span class="o">*</span><span class="n">offset_ms</span><span class="o">/</span><span class="mi">1000</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clsfr=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clsfr</span><span class="p">))</span>
    
    <span class="n">calibration_dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">current_mode</span> <span class="o">=</span> <span class="s2">&quot;idle&quot;</span>
    <span class="c1"># clean shutdown when told shutdown</span>
    <span class="k">while</span> <span class="n">current_mode</span><span class="o">.</span><span class="n">lower</span> <span class="o">!=</span> <span class="s2">&quot;shutdown&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>

        <span class="k">if</span>  <span class="n">current_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;calibration.supervised&quot;</span><span class="p">,</span><span class="s2">&quot;calibrate.supervised&quot;</span><span class="p">):</span>
            <span class="n">calibration_dataset</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">doCalibrationSupervised</span><span class="p">(</span><span class="n">ui</span><span class="p">,</span> <span class="n">clsfr</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">previous_dataset</span><span class="o">=</span><span class="n">calibration_dataset</span><span class="p">)</span>
                
        <span class="k">elif</span> <span class="n">current_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;prediction.static&quot;</span><span class="p">,</span><span class="s2">&quot;predict.static&quot;</span><span class="p">):</span>
            <span class="n">doPredictionStatic</span><span class="p">(</span><span class="n">ui</span><span class="p">,</span> <span class="n">clsfr</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">current_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;reset&quot;</span><span class="p">):</span>
            <span class="n">calibration_dataset</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># check for new mode-messages</span>
        <span class="n">newmsgs</span><span class="p">,</span> <span class="n">nsamp</span><span class="p">,</span> <span class="n">nstim</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># update the system mode</span>
        <span class="n">current_mode</span> <span class="o">=</span> <span class="s2">&quot;idle&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newmsgs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">msgID</span> <span class="o">==</span> <span class="n">ModeChange</span><span class="o">.</span><span class="n">msgID</span><span class="p">:</span>
                <span class="n">current_mode</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">newmode</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">New Mode: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_mode</span><span class="p">))</span>
                <span class="n">ui</span><span class="o">.</span><span class="n">push_back_newmsgs</span><span class="p">(</span><span class="n">newmsgs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                <span class="c1"># stop processing messages</span>
                <span class="k">break</span>
        
        <span class="c1"># BODGE: re-draw plots so they are interactive.</span>
        <span class="k">if</span> <span class="n">guiplots</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_fignums</span><span class="p">():</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span></div>

<div class="viewcode-block" id="mainloop"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.decoder.mainloop">[docs]</a><span class="k">def</span> <span class="nf">mainloop</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="k">if</span>  <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--host&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;address (IP) of the utopia-hub&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--out_fs&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;output sample rate&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tau_ms&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;output sample rate&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">450</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--evtlabs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;comma separated list of stimulus even types to use&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;re,fe&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--stopband&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;set of notch filters to apply to the data before analysis&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">((</span><span class="mi">45</span><span class="p">,</span><span class="mi">65</span><span class="p">),(</span><span class="mf">5.5</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="s1">&#39;bandpass&#39;</span><span class="p">)))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cv&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number cross validation folds&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--predplots&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;flag make decoding plots are prediction time&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--calplots&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;turn OFF model and decoding plots after calibration&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--savefile&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;run decoder using this file as the proxy data source&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--savefile_fs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;effective sample rate for the save file&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">savefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span><span class="c1">#</span>
        <span class="c1">#setattr(args,&#39;savefile&#39;,&quot;~/utopia/java/messagelib/UtopiaMessages_.log&quot;)</span>
        <span class="c1">#setattr(args,&#39;savefile&#39;,&quot;~/utopia/java/utopia2ft/UtopiaMessages_*1700.log&quot;)</span>
        <span class="c1">#setattr(args,&#39;savefile&#39;,&quot;~/Downloads/jason/UtopiaMessages_200923_1749_*.log&quot;)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="s1">&#39;savefile&#39;</span><span class="p">,</span><span class="s1">&#39;~/Desktop/mark/mindaffectBCI*ganglion*1404*.txt&#39;</span><span class="p">)</span>
        <span class="c1">#setattr(args,&#39;out_fs&#39;,100)</span>
        <span class="c1">#setattr(args,&#39;savefile_fs&#39;,200)</span>
        <span class="c1">#setattr(args,&#39;cv&#39;,5)</span>
        <span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.FileProxyHub</span> <span class="kn">import</span> <span class="n">FileProxyHub</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">FileProxyHub</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">savefile</span><span class="p">,</span><span class="n">use_server_ts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ppfn</span> <span class="o">=</span> <span class="n">butterfilt_and_downsample</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">stopband</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">stopband</span><span class="p">,</span> <span class="n">fs_out</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">out_fs</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;butter&#39;</span><span class="p">)</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">UtopiaDataInterface</span><span class="p">(</span><span class="n">data_preprocessor</span><span class="o">=</span><span class="n">ppfn</span><span class="p">,</span>
                                 <span class="n">stimulus_preprocessor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">timeout_ms</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mintime_ms</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="n">U</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">savefile_fs</span><span class="p">)</span> <span class="c1"># 20hz updates</span>
        <span class="c1"># add the file-proxy ui as input argument</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="s1">&#39;ui&#39;</span><span class="p">,</span><span class="n">ui</span><span class="p">)</span>
    
    <span class="n">running</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">nCrash</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">running</span> <span class="ow">and</span> <span class="n">nCrash</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
            <span class="c1"># stop restarting if normal terminate</span>
            <span class="n">running</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="c1"># stop running if keyboard interrrupt</span>
            <span class="n">running</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error running mainloop&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="n">nCrash</span> <span class="o">=</span> <span class="n">nCrash</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">pass</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Mark van Kesteren

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>