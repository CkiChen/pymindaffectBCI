

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mindaffectBCI.decoder.model_fitting &mdash; mindaffectBCI - documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> mindaffectBCI
          

          
            
            <img src="../../../_static/MindAffect_Logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../OnlineBCI_quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">mindaffectBCI</a></li>
</ul>
<p class="caption"><span class="caption-text">The headset</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../printing_guide.html">Print Your Own Headset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fitting_guide.html">Setup &amp; fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../headset_layout.html">Headset layout</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mindaffectBCI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>mindaffectBCI.decoder.model_fitting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mindaffectBCI.decoder.model_fitting</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.updateSummaryStatistics</span> <span class="kn">import</span> <span class="n">updateSummaryStatistics</span><span class="p">,</span> <span class="n">zero_outliers</span><span class="p">,</span> <span class="n">crossautocov</span><span class="p">,</span> <span class="n">updateCyy</span><span class="p">,</span> <span class="n">updateCxy</span><span class="p">,</span> <span class="n">autocov</span><span class="p">,</span> <span class="n">updateCxx</span><span class="p">,</span> <span class="n">plot_erp</span><span class="p">,</span> <span class="n">plot_summary_statistics</span><span class="p">,</span> <span class="n">plot_factoredmodel</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.multipleCCA</span> <span class="kn">import</span> <span class="n">multipleCCA</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.scoreOutput</span> <span class="kn">import</span> <span class="n">scoreOutput</span><span class="p">,</span> <span class="n">dedupY0</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.utils</span> <span class="kn">import</span> <span class="n">window_axis</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.scoreStimulus</span> <span class="kn">import</span> <span class="n">scoreStimulus</span><span class="p">,</span> <span class="n">scoreStimulusCont</span><span class="p">,</span> <span class="n">factored2full</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.decodingCurveSupervised</span> <span class="kn">import</span> <span class="n">decodingCurveSupervised</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.decodingSupervised</span> <span class="kn">import</span> <span class="n">decodingSupervised</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.stim2event</span> <span class="kn">import</span> <span class="n">stim2event</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.normalizeOutputScores</span> <span class="kn">import</span> <span class="n">normalizeOutputScores</span><span class="p">,</span> <span class="n">estimate_Fy_noise_variance</span>
<span class="kn">from</span> <span class="nn">mindaffectBCI.decoder.zscore2Ptgt_softmax</span> <span class="kn">import</span> <span class="n">calibrate_softmaxscale</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>
    <span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">ClassifierMixin</span>
    <span class="kn">from</span> <span class="nn">sklearn.exceptions</span> <span class="kn">import</span> <span class="n">NotFittedError</span>
<span class="k">except</span><span class="p">:</span>
<span class="c1">#  if True:</span>
    <span class="c1"># placeholder classes for when sklearn isn&#39;t available</span>
    <span class="k">class</span> <span class="nc">StratifiedKFold</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_splits</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_splits</span> <span class="o">=</span> <span class="n">n_splits</span>

        <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_splits</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">train_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">]))</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">val_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">BaseEstimator</span><span class="p">:</span>
        <span class="k">pass</span>


    <span class="k">class</span> <span class="nc">ClassifierMixin</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">class</span> <span class="nc">NotFittedError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>
    
<div class="viewcode-block" id="BaseSequence2Sequence"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BaseSequence2Sequence">[docs]</a><span class="k">class</span> <span class="nc">BaseSequence2Sequence</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">ClassifierMixin</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Base class for sequence-to-sequence learning.  Provides, prediction and scoring functions, but not the fitting method&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;re&#39;</span><span class="p">,</span><span class="s1">&#39;fe&#39;</span><span class="p">),</span> <span class="n">tau</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">outputscore</span><span class="o">=</span><span class="s1">&#39;ip&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evtlabs</span> <span class="o">=</span> <span class="n">evtlabs</span> <span class="k">if</span> <span class="n">evtlabs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;re&#39;</span><span class="p">,</span><span class="s1">&#39;fe&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputscore</span> <span class="o">=</span> <span class="n">outputscore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorweight</span> <span class="o">=</span> <span class="mi">120</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="o">&lt;-</span><span class="n">tau</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Offsets of more than a negative window are not supported yet!&quot;</span><span class="p">)</span>
        
<div class="viewcode-block" id="BaseSequence2Sequence.stim2event"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BaseSequence2Sequence.stim2event">[docs]</a>    <span class="k">def</span> <span class="nf">stim2event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">prevY</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;transform Stimulus-encoded to brain-encoded, if needed&#39;&#39;&#39;</span>
        <span class="c1"># convert from stimulus coding to brain response coding</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">evtlabs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">stim2event</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">oM</span><span class="o">=</span><span class="n">prevY</span><span class="p">)</span> <span class="c1"># (tr, samp, Y, e)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1"># (tr,samp,Y,e)</span>

        <span class="k">return</span> <span class="n">Y</span></div>

<div class="viewcode-block" id="BaseSequence2Sequence.fit"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BaseSequence2Sequence.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;fit model mapping 2 multi-dim time series: X = (tr, samp, d), Y = (tr, samp, e)&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span></div>

<div class="viewcode-block" id="BaseSequence2Sequence.is_fitted"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BaseSequence2Sequence.is_fitted">[docs]</a>    <span class="k">def</span> <span class="nf">is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;W_&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseSequence2Sequence.predict"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BaseSequence2Sequence.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prevY</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;make predictions on multi-dim time series: X = (tr, samp, d), Y = (tr, samp, e)</span>
<span class="sd">        </span>
<span class="sd">        N.B. this implementation assumes linear coefficients in W_ (nM,nfilt,d) and R_ (nM,nfilt,nE,tau)&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">():</span>
            <span class="c1"># only if we&#39;ve been fitted!</span>
            <span class="k">raise</span> <span class="n">NotFittedError</span>
        <span class="c1"># convert from stimulus coding to brain response coding</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim2event</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">prevY</span><span class="p">)</span>
        <span class="c1"># valid performance</span>
        <span class="n">Fe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="c1"># (nM, nTrl, nSamp, nE)</span>
        <span class="n">Fy</span> <span class="o">=</span> <span class="n">scoreOutput</span><span class="p">(</span><span class="n">Fe</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">outputscore</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outputscore</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="n">dedup0</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">R_</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span> <span class="c1">#(nM, nTrl, nSamp, nY)</span>
        <span class="c1"># BODGE: strip un-needed model dimension</span>
        <span class="k">if</span> <span class="n">Fy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">Fy</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">Fy</span> <span class="o">=</span> <span class="n">Fy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Fy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">Fy</span></div>

<div class="viewcode-block" id="BaseSequence2Sequence.transform"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BaseSequence2Sequence.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; estimate the stimulus properties from the raw data &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">scoreStimulus</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseSequence2Sequence.decode_proba"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BaseSequence2Sequence.decode_proba">[docs]</a>    <span class="k">def</span> <span class="nf">decode_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Fy</span><span class="p">,</span> <span class="n">minDecisLen</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">marginalizemodels</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># build optional arguments if set</span>
        <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;sigma0_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma0_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># include the score prior</span>
            <span class="c1">#print(&#39;priorsigma=({},{})&#39;.format(self.sigma0_,self.priorweight))</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;priorsigma&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma0_</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">priorweight</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;softmaxscale_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmaxscale_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;softmaxscale&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">softmaxscale_</span>

        <span class="n">Yest</span><span class="p">,</span> <span class="n">Perr</span><span class="p">,</span> <span class="n">Ptgt</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">decodingSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">,</span> <span class="n">minDecisLen</span><span class="o">=</span><span class="n">minDecisLen</span><span class="p">,</span> <span class="n">marginalizemodels</span><span class="o">=</span><span class="n">marginalizemodels</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Ptgt</span> <span class="c1">#(nTrl, nEp, nY)</span></div>

    
<div class="viewcode-block" id="BaseSequence2Sequence.predict_proba"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BaseSequence2Sequence.predict_proba">[docs]</a>    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">marginalizemodels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">minDecisLen</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prevY</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">Fy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="n">dedup0</span><span class="p">,</span> <span class="n">prevY</span><span class="o">=</span><span class="n">prevY</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_proba</span><span class="p">(</span><span class="n">Fy</span><span class="p">,</span><span class="n">marginalizemodels</span><span class="o">=</span><span class="n">marginalizemodels</span><span class="p">,</span> <span class="n">minDecisLen</span><span class="o">=</span><span class="n">minDecisLen</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseSequence2Sequence.score"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BaseSequence2Sequence.score">[docs]</a>    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;score this model on this data, N.B. for model_selection higher is *better*&#39;&#39;&#39;</span>
        <span class="c1"># score, removing duplicates for true target (objId==0) so can compute score</span>
        <span class="n">Fy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># (nM, nTrl, nSamp, e)</span>

        <span class="k">return</span> <span class="n">BaseSequence2Sequence</span><span class="o">.</span><span class="n">audc_score</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseSequence2Sequence.audc_score"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BaseSequence2Sequence.audc_score">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">audc_score</span><span class="p">(</span><span class="n">Fy</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;compute area under decoding curve score from Fy, *assuming* Fy[:,:,0] is the *true* classes score&#39;&#39;&#39;</span>
        <span class="n">sFy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">Fy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># (nM, nTrl, nSamp, nY)</span>
        <span class="n">Yi</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sFy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># output for every model*trial*sample</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Yi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span><span class="o">/</span><span class="n">Yi</span><span class="o">.</span><span class="n">size</span> <span class="c1"># total amount time was right, higher=better</span>
        <span class="k">return</span> <span class="n">score</span></div>

<div class="viewcode-block" id="BaseSequence2Sequence.cv_fit"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BaseSequence2Sequence.cv_fit">[docs]</a>    <span class="k">def</span> <span class="nf">cv_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fit_params</span><span class="o">=</span><span class="p">{},</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_estimator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">calibrate_softmax</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; cross validated fit to the data.  N.B. write our own as sklearn doesn&#39;t work for getting the estimator values for structured output.&#39;&#39;&#39;</span>
        <span class="c1"># TODO [] : make more computationally efficient by pre-computing the updateSummaryStatistics etc.</span>
        <span class="c1"># TODO [] : conform to sklearn cross_validate signature</span>
        <span class="c1"># TODO [] : move into a wrapper class</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># single trial, train/test on all...</span>
                <span class="n">cv</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span> <span class="c1"># N.B. use slice to preserve dims..</span>

        <span class="k">if</span> <span class="n">return_estimator</span><span class="p">:</span>
            <span class="n">Fy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span><span class="o">&lt;=</span><span class="mi">3</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># (nTrl, nEp, nY)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Fy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CV:&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">valid_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cv</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#print(&quot;trn={} val={}&quot;.format(train_idx,valid_idx))</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">train_idx</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">train_idx</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>

            <span class="c1"># predict, forcing removal of copies of  tgt=0 so can score</span>
            <span class="n">Fyi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">dedup0</span><span class="o">=</span><span class="n">dedup0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_estimator</span><span class="p">:</span>
                <span class="n">Fy</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fyi</span>
            
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audc_score</span><span class="p">(</span><span class="n">Fyi</span><span class="p">))</span>

        <span class="c1"># final retrain with all the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigma0_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">softmaxscale_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">return_estimator</span><span class="p">:</span>
            <span class="c1"># estimate prior for Fy using the cv&#39;d Fy</span>
            <span class="c1">#self.sigma0_ = np.sum(Fy.ravel()**2) / Fy.size</span>
            <span class="c1">#print(&#39;Fy={}&#39;.format(Fy.shape))</span>
            <span class="c1"># N.B. need to match the filter used in the decoder..</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma0_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">estimate_Fy_noise_variance</span><span class="p">(</span><span class="n">Fy</span><span class="p">,</span> <span class="n">priorsigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># per-trial</span>
            <span class="c1">#print(&#39;Sigma0{} = {}&#39;.format(self.sigma0_.shape,self.sigma0_))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma0_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma0_</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>  <span class="c1"># ave</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sigma0 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma0_</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">calibrate_softmax</span><span class="p">:</span>
                <span class="c1"># calibrate the softmax scale to give more valid probabilities</span>
                <span class="n">nFy</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">normalizeOutputScores</span><span class="p">(</span><span class="n">Fy</span><span class="p">,</span> <span class="n">minDecisLen</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span> <span class="n">priorsigma</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma0_</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">priorweight</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">softmaxscale_</span> <span class="o">=</span> <span class="n">calibrate_softmaxscale</span><span class="p">(</span><span class="n">nFy</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;estimator&#39;</span><span class="p">:</span> <span class="n">Fy</span><span class="p">,</span> <span class="s1">&#39;test_score&#39;</span><span class="p">:</span> <span class="n">scores</span><span class="p">}</span></div>
    
<div class="viewcode-block" id="BaseSequence2Sequence.plot_model"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BaseSequence2Sequence.plot_model">[docs]</a>    <span class="k">def</span> <span class="nf">plot_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plot Factored Model&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;A_&#39;</span><span class="p">):</span>
                <span class="n">plot_factoredmodel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evtlabs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_factoredmodel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evtlabs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_erp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evtlabs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>

    
<div class="viewcode-block" id="MultiCCA"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.MultiCCA">[docs]</a><span class="k">class</span> <span class="nc">MultiCCA</span><span class="p">(</span><span class="n">BaseSequence2Sequence</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Sequence 2 Sequence learning using CCA as a bi-directional forward/backward learning method &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;re&#39;</span><span class="p">,</span><span class="s1">&#39;fe&#39;</span><span class="p">),</span> <span class="n">tau</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">badEpThresh</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">symetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">CCA</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>  <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span>  <span class="o">=</span> <span class="n">reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rcond</span><span class="o">=</span> <span class="n">rcond</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">badEpThresh</span> <span class="o">=</span> <span class="n">badEpThresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symetric</span> <span class="o">=</span> <span class="n">symetric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CCA</span> <span class="o">=</span> <span class="n">CCA</span>

<div class="viewcode-block" id="MultiCCA.fit"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.MultiCCA.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">stimTimes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;fit 2 multi-dim time series: X = (tr, samp, d), Y = (tr, samp, Y)&#39;&#39;&#39;</span>
        <span class="c1"># map to event sequence</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim2event</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="c1"># (tr,samp,nY,e)</span>
        <span class="c1"># extract the true target to fit to, using horible slicing trick</span>
        <span class="n">Y_true</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="c1">#  (tr,samp,1,e)</span>
        <span class="c1"># get summary statistics</span>
        <span class="c1">#print(&quot;X={} |X|={}&quot;.format(X.shape,np.sum(X**2,axis=(0,1))))</span>
        <span class="n">Cxx</span><span class="p">,</span> <span class="n">Cxy</span><span class="p">,</span> <span class="n">Cyy</span> <span class="o">=</span> <span class="n">updateSummaryStatistics</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y_true</span><span class="p">,</span> <span class="n">stimTimes</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">badEpThresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">badEpThresh</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">)</span>
        <span class="c1">#print(&quot;diag(Cxx)={}&quot;.format(np.diag(Cxx)))</span>
        <span class="c1"># do the CCA fit</span>
        <span class="n">J</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">multipleCCA</span><span class="p">(</span><span class="n">Cxx</span><span class="p">,</span> <span class="n">Cxy</span><span class="p">,</span> <span class="n">Cyy</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rcond</span><span class="p">,</span> <span class="n">CCA</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CCA</span><span class="p">,</span> <span class="n">symetric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symetric</span><span class="p">)</span>
        <span class="c1"># maintain type compatiability</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_</span> <span class="o">=</span> <span class="n">W</span> <span class="c1">#(nM,rank,d)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_</span> <span class="o">=</span> <span class="n">R</span> <span class="c1">#(nM,rank,e,tau)</span>
        <span class="c1"># store A_ for plotting later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;de,Mkd-&gt;Mke&quot;</span><span class="p">,</span><span class="n">Cxx</span><span class="p">,</span><span class="n">W</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">:</span> <span class="c1"># use bias terms to correct for data centering</span>
            <span class="n">muX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;Mkd,d,Mket-&gt;Me&quot;</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="n">muX</span><span class="p">,</span><span class="n">R</span><span class="p">)</span> <span class="c1"># (nM,d)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="c1"># strip model dim..</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span></div></div>
    
<div class="viewcode-block" id="FwdLinearRegression"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.FwdLinearRegression">[docs]</a><span class="k">class</span> <span class="nc">FwdLinearRegression</span><span class="p">(</span><span class="n">BaseSequence2Sequence</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Sequence 2 Sequence learning using forward linear regression  X = A*Y &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;re&#39;</span><span class="p">,</span><span class="s1">&#39;fe&#39;</span><span class="p">),</span> <span class="n">tau</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">badEpThresh</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rcond</span> <span class="o">=</span> <span class="n">rcond</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">badEpThresh</span> <span class="o">=</span> <span class="n">badEpThresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: not tested with offset!! YMMV&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="FwdLinearRegression.fit"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.FwdLinearRegression.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;fit 2 multi-dim time series: X = (tr, samp, d), Y = (tr, samp, e)&#39;&#39;&#39;</span>
        <span class="c1"># map to event sequence</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim2event</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="c1"># (tr,samp,nY,e)</span>
        <span class="c1"># extract the true target to fit to</span>
        <span class="n">Y_true</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="c1"># (tr,samp, e)</span>
        <span class="c1"># get summary statistics</span>
        <span class="c1"># first clean up the data..</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y_true</span> <span class="o">=</span> <span class="n">zero_outliers</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y_true</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">badEpThresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">:</span>
            <span class="c1"># TODO[]: make work in-place w/o modify X</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">muX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">muX</span>
        <span class="c1"># TODO: should be negative tau to represent causality of Y-&gt;X, so earlier Y cause X</span>
        <span class="n">Cyteyte</span> <span class="o">=</span> <span class="n">crossautocov</span><span class="p">(</span><span class="n">Y_true</span><span class="p">,</span> <span class="n">Y_true</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span> <span class="c1"># (tau,e,tau,e) cross-cov shifted Y with itself</span>
        <span class="c1"># N.B. should be shifted Y with X, but we want Y *backwards* in time, thus</span>
        <span class="c1">#      as a *BODGE* we instead window X, as forward for X == backwards for Y</span>
        <span class="c1">#Cytexd  = crossautocov(Y_true, X, tau=[-self.tau, 1]) # (tau,e,1,d) shifted Y with X</span>
        <span class="n">Cytexd</span>  <span class="o">=</span> <span class="n">crossautocov</span><span class="p">(</span><span class="n">Y_true</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">],</span> <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span> <span class="c1"># (1,e,tau,d) shifted X with Y</span>
        <span class="n">Cytexd</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">Cytexd</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="c1"># (tau,e,1,d)</span>
        <span class="c1"># fit:</span>
        <span class="c1"># Make 2d</span>
        <span class="c1"># (tau,e,tau,e) -&gt; ((tau*e),(tau*e))</span>
        <span class="n">Cyy2d</span> <span class="o">=</span> <span class="n">Cyteyte</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Cyteyte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Cyteyte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">Cyteyte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Cyteyte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="c1"># (tau,e,1,d) -&gt; ((tau*e),d)</span>
        <span class="n">Cyx2d</span> <span class="o">=</span> <span class="n">Cytexd</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">(</span><span class="n">Cytexd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Cytexd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">Cytexd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="c1"># add regularization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">:</span>
            <span class="c1"># **IN-PLACE modify Cyy2d..**</span>
            <span class="n">diag</span><span class="o">=</span><span class="n">Cyy2d</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">Cyy2d</span><span class="p">,</span> <span class="n">diag</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">diag</span><span class="p">))</span>
        
        <span class="c1"># fit by solving the matrix equation: Cyy*A=Cyx -&gt; A=Cyy**-1Cyx</span>
        <span class="c1"># Q: solve or lstsq?</span>
        <span class="c1">#R = np.linalg.solve(Cyy2d, Cyx2d) # ((tau*e),d)</span>
        <span class="n">R</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">Cyy2d</span><span class="p">,</span> <span class="n">Cyx2d</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rcond</span><span class="p">)</span> <span class="c1"># ((tau*e),d)</span>
        <span class="c1"># convert back to 2d (tau,e,d)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Cyteyte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Cyteyte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1"># BODGE: now moveaxis to make consistent with the prediction functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="c1">#(tau,e,d)-&gt;(e,tau,d)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;etd,d-&gt;e&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_</span><span class="p">,</span> <span class="n">muX</span><span class="p">)</span> <span class="c1">#(e,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span></div></div>

<div class="viewcode-block" id="BwdLinearRegression"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BwdLinearRegression">[docs]</a><span class="k">class</span> <span class="nc">BwdLinearRegression</span><span class="p">(</span><span class="n">BaseSequence2Sequence</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Sequence 2 Sequence learning using backward linear regression  W*X = Y &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;re&#39;</span><span class="p">,</span><span class="s1">&#39;fe&#39;</span><span class="p">),</span> <span class="n">tau</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">badEpThresh</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rcond</span> <span class="o">=</span> <span class="n">rcond</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">badEpThresh</span> <span class="o">=</span> <span class="n">badEpThresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: not tested with offset!! YMMV&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="BwdLinearRegression.fit"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.BwdLinearRegression.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;fit 2 multi-dim time series: X = (tr, samp, d), Y = (tr, samp, e)&#39;&#39;&#39;</span>
        <span class="c1"># map to event sequence</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim2event</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="c1"># (tr,samp,nY,e)</span>
        <span class="c1"># extract the true target to fit to</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="c1"># (tr,samp, e)</span>
        <span class="c1"># first clean up the data..</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">zero_outliers</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">badEpThresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">:</span>
            <span class="c1"># TODO[]: make work in-place w/o modify X</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">muX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">muX</span>
        <span class="c1"># get summary statistics</span>
        <span class="n">Cxtdxtd</span> <span class="o">=</span> <span class="n">crossautocov</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span> <span class="c1"># (tau,d,tau,d) cross-cov shifted X with itself</span>
        <span class="n">Cxtdye</span>  <span class="o">=</span> <span class="n">crossautocov</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span> <span class="c1"># (tau,d,1,e) shifted X with Y</span>
        <span class="c1"># fit:</span>
        <span class="c1"># Make 2d</span>
        <span class="c1"># (tau,d,tau,d) -&gt; ((tau*d),(tua*d))</span>
        <span class="n">Cxx2d</span> <span class="o">=</span> <span class="n">Cxtdxtd</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Cxtdxtd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Cxtdxtd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">Cxtdxtd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">Cxtdxtd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="c1"># (tau,d,1,e) -&gt; ((tau*d),e)</span>
        <span class="n">Cxy2d</span> <span class="o">=</span> <span class="n">Cxtdye</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">(</span><span class="n">Cxtdye</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Cxtdye</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">Cxtdye</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="c1"># add regularization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">:</span>
            <span class="c1"># **IN-PLACE modify Cxx2d..**</span>
            <span class="n">diag</span> <span class="o">=</span> <span class="n">Cxx2d</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">Cxx2d</span><span class="p">,</span> <span class="n">diag</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">diag</span><span class="p">))</span>
        
        <span class="c1"># fit by solving the matrix equation: Cxx*W=Cxy -&gt; W=Cxx**-1Cxy</span>
        <span class="n">W</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">Cxx2d</span><span class="p">,</span> <span class="n">Cxy2d</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rcond</span><span class="p">)</span> <span class="c1"># ((tau*d*),e)</span>
        <span class="c1">#W = np.linalg.solve(Cxx2d, Cxy2d) # ((tau*d*),e) # can have problems with singular inputs!</span>
        <span class="c1"># convert back to 2d</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Cxtdxtd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Cxtdxtd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># (tau,d,e)</span>
        <span class="c1"># BODGE: moveaxis to make consistent for the prediction functions</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="c1">#(tau,d,e)-&gt;(e,tau,d)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_</span> <span class="o">=</span> <span class="n">W</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;etd,d-&gt;e&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">W_</span><span class="p">,</span><span class="n">muX</span><span class="p">)</span> <span class="c1">#(e,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span></div></div>

<span class="c1">#from sklearn.linear_model import Ridge</span>
<div class="viewcode-block" id="LinearSklearn"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.LinearSklearn">[docs]</a><span class="k">class</span> <span class="nc">LinearSklearn</span><span class="p">(</span><span class="n">BaseSequence2Sequence</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Wrap a normal sk-learn classifier for sequence to sequence learning &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clsfr</span><span class="p">,</span> <span class="n">labelizeY</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_unlabelled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">badEpThresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clsfr</span> <span class="o">=</span> <span class="n">clsfr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labelizeY</span> <span class="o">=</span> <span class="n">labelizeY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">badEpThresh</span> <span class="o">=</span> <span class="n">badEpThresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_unlabelled</span> <span class="o">=</span> <span class="n">ignore_unlabelled</span>
        
<div class="viewcode-block" id="LinearSklearn.sklearn_fit"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.LinearSklearn.sklearn_fit">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sklearn_fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">clsfr</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">labelizeY</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_unlabelled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">badEpThresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;fit 2 multi-dim time series: X = (tr, samp, d), Y = (tr, samp, e) using a given sklearn linear_model method&#39;&#39;&#39;</span>
        <span class="c1"># slice X to get block of data per sample</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">window_axis</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">winsz</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># (tr,samp-tau,tau,d)</span>
        <span class="c1"># sub-set Y to  be the same size</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">offset</span><span class="p">:</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="p">:]</span> <span class="c1"># (tr,samp-tau,e)</span>

        <span class="c1"># clean up the data</span>
        <span class="k">if</span> <span class="n">badEpThresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">zero_outliers</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">badEpThresh</span><span class="p">)</span>

        <span class="c1"># convert to a 2d array: (tr*samp, feat) before giving to sklearn</span>
        <span class="n">X2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])))</span> <span class="c1">#((tr*samp-tau),(tau*d))</span>
        <span class="n">Y2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])))</span> <span class="c1">#((tr*samp-tau),e)</span>
        <span class="k">if</span> <span class="n">labelizeY</span><span class="p">:</span> <span class="c1"># convert Y to a label list</span>
            <span class="n">Ylab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Y2d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># ((tr*samp),1)</span>
            <span class="n">unlabelled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Y2d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">unlabelled</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ignore_unlabelled</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: removing unlabelled examples from training&quot;</span><span class="p">)</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="o">~</span><span class="n">unlabelled</span>
                    <span class="n">Ylab</span><span class="o">=</span> <span class="n">Ylab</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
                    <span class="n">Y2d</span> <span class="o">=</span> <span class="n">Y2d</span><span class="p">[</span><span class="n">keep</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                    <span class="n">X2d</span> <span class="o">=</span> <span class="n">X2d</span><span class="p">[</span><span class="n">keep</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X=</span><span class="si">{}</span><span class="s2"> Y=</span><span class="si">{}</span><span class="s2"> Ylab=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">X2d</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">Y2d</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Ylab</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: added an extra &#39;REST&#39; class&quot;</span><span class="p">)</span>
                    <span class="c1"># add extra class for anything which isn&#39;t labelled already</span>
                    <span class="n">Ylab</span><span class="p">[</span><span class="n">unlabelled</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y2d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                
            <span class="n">Y2d</span> <span class="o">=</span> <span class="n">Ylab</span>
        <span class="c1"># fit the classifier</span>
        <span class="n">clsfr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X2d</span><span class="p">,</span> <span class="n">Y2d</span><span class="p">)</span>

        <span class="c1"># log the binary training set performance.</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training score = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clsfr</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X2d</span><span class="p">,</span><span class="n">Y2d</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">clsfr</span></div>

<div class="viewcode-block" id="LinearSklearn.fit"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.LinearSklearn.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="c1"># map to event sequence</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim2event</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="c1"># extract the true target to fit to</span>
        <span class="n">Y_true</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="c1">#  (tr,samp,e)</span>
        <span class="c1"># fit the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clsfr</span> <span class="o">=</span> <span class="n">LinearSklearn</span><span class="o">.</span><span class="n">sklearn_fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y_true</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsfr</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">labelizeY</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labelizeY</span><span class="p">,</span> <span class="n">ignore_unlabelled</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_unlabelled</span><span class="p">,</span> <span class="n">badEpThresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">badEpThresh</span><span class="p">)</span>
        <span class="c1"># extract the solution coefficient and store in W_</span>
        <span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsfr</span><span class="o">.</span><span class="n">coef_</span> <span class="c1"># ( n_class, n_feat ) = (e,(tau*d)))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsfr</span><span class="o">.</span><span class="n">intercept_</span> <span class="c1"># (e,1)</span>
        <span class="c1">#print(&quot;W={}&quot;.format(W.shape))</span>
        <span class="c1">#print(&quot;b={}&quot;.format(b.shape))</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># (e,tau,d)</span>
        <span class="c1">#print(&quot;W={}&quot;.format(W.shape))</span>

        <span class="c1"># ensure the weights vector is the right size ...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelizeY</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">Y_true</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>

            <span class="k">if</span> <span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;More weights than outputs! Y=</span><span class="si">{}</span><span class="s2"> W=</span><span class="si">{}</span><span class="s2"> removed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">W</span><span class="p">[:</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fewer weights than outputs! Y=</span><span class="si">{}</span><span class="s2"> W=</span><span class="si">{}</span><span class="s2"> binary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="c1"># Y is binary, so e==0 -&gt; neg-class,  e==1 -&gt; pos-class</span>
                <span class="c1"># TODO[]: check?</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="o">-</span><span class="n">W</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know what to do with W&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">W_</span> <span class="o">=</span> <span class="n">W</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_</span> <span class="o">=</span> <span class="n">b</span>
        <span class="c1">#print(&quot;b={}&quot;.format(b))</span>

        <span class="k">return</span> <span class="bp">self</span></div></div>
    
<div class="viewcode-block" id="visualize_Fy_Py"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.visualize_Fy_Py">[docs]</a><span class="k">def</span> <span class="nf">visualize_Fy_Py</span><span class="p">(</span><span class="n">Fy</span><span class="p">,</span> <span class="n">Py</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">trli</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Fy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trli</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">Fy</span><span class="p">[</span><span class="n">trli</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="o">-</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Py</span><span class="p">[</span><span class="n">trli</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trli</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_model_weights"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.plot_model_weights">[docs]</a><span class="k">def</span> <span class="nf">plot_model_weights</span><span class="p">(</span><span class="n">model</span><span class="p">:</span><span class="n">BaseSequence2Sequence</span><span class="p">,</span> <span class="n">ch_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">updateSummaryStatistics</span> <span class="kn">import</span> <span class="n">plot_erp</span>
    <span class="kn">from</span> <span class="nn">scoreStimulus</span> <span class="kn">import</span> <span class="n">factored2full</span>
    <span class="n">plot_erp</span><span class="p">(</span><span class="n">factored2full</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">W_</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">R_</span><span class="p">),</span> <span class="n">ch_names</span><span class="o">=</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span></div>

<div class="viewcode-block" id="testLeadLag"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.testLeadLag">[docs]</a><span class="k">def</span> <span class="nf">testLeadLag</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">testSignal</span>
    <span class="kn">from</span> <span class="nn">model_fitting</span> <span class="kn">import</span> <span class="n">MultiCCA</span>    
    <span class="kn">from</span> <span class="nn">decodingCurveSupervised</span> <span class="kn">import</span> <span class="n">decodingCurveSupervised</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

    <span class="n">irf</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="c1"># X-&gt;lag-by-10</span>
    <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span> <span class="o">=</span> <span class="n">testSignal</span><span class="p">(</span><span class="n">nTrl</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nSamp</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nE</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nY</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">isi</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span><span class="n">irf</span><span class="o">=</span><span class="n">irf</span><span class="p">,</span><span class="n">noise2signal</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># reference case lagged response test</span>
    <span class="n">evtlabs</span><span class="o">=</span><span class="kc">None</span><span class="p">;</span> <span class="n">tau</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span> <span class="n">cca_offset</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">cca</span> <span class="o">=</span> <span class="n">MultiCCA</span><span class="p">(</span><span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">cca_offset</span><span class="p">)</span>
    <span class="n">scores</span><span class="o">=</span><span class="n">cca</span><span class="o">.</span><span class="n">cv_fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;estimator&#39;</span><span class="p">]</span>
    <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span>
        
    <span class="c1"># leading X</span>
    <span class="n">irf</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">offset</span><span class="o">=-</span><span class="mi">9</span><span class="p">;</span> <span class="c1"># X leads by 9</span>
    <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span> <span class="o">=</span> <span class="n">testSignal</span><span class="p">(</span><span class="n">nTrl</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nSamp</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nE</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nY</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">isi</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span><span class="n">irf</span><span class="o">=</span><span class="n">irf</span><span class="p">,</span><span class="n">noise2signal</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;offset=</span><span class="si">{}</span><span class="s2">, irf=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="n">irf</span><span class="p">));</span><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># no-shift in analysis window</span>
    <span class="n">evtlabs</span><span class="o">=</span><span class="kc">None</span><span class="p">;</span> <span class="n">tau</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span> <span class="n">cca_offset</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">cca</span> <span class="o">=</span> <span class="n">MultiCCA</span><span class="p">(</span><span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="n">cca_offset</span><span class="p">)</span>
    <span class="n">scores</span><span class="o">=</span><span class="n">cca</span><span class="o">.</span><span class="n">cv_fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;estimator&#39;</span><span class="p">]</span>
    <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span>

    <span class="c1"># shifted analysis window</span>
    <span class="n">evtlabs</span><span class="o">=</span><span class="kc">None</span><span class="p">;</span> <span class="n">tau</span><span class="o">=</span><span class="mi">20</span><span class="p">;</span> <span class="n">cca_offset</span><span class="o">=-</span><span class="mi">9</span>
    <span class="n">cca</span> <span class="o">=</span> <span class="n">MultiCCA</span><span class="p">(</span><span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="n">cca_offset</span><span class="p">)</span>
    <span class="n">scores</span><span class="o">=</span><span class="n">cca</span><span class="o">.</span><span class="n">cv_fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;estimator&#39;</span><span class="p">]</span>
    <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span><span class="n">plot_model_weights</span><span class="p">(</span><span class="n">cca</span><span class="p">)</span></div>
    
        
<div class="viewcode-block" id="testcase"><a class="viewcode-back" href="../../../mindaffectBCI.decoder.html#mindaffectBCI.decoder.model_fitting.testcase">[docs]</a><span class="k">def</span> <span class="nf">testcase</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;toy&#39;</span><span class="p">,</span><span class="n">loader_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">()):</span>
    <span class="kn">from</span> <span class="nn">model_fitting</span> <span class="kn">import</span> <span class="n">MultiCCA</span><span class="p">,</span> <span class="n">FwdLinearRegression</span><span class="p">,</span> <span class="n">BwdLinearRegression</span><span class="p">,</span> <span class="n">LinearSklearn</span>
    <span class="kn">from</span> <span class="nn">decodingCurveSupervised</span> <span class="kn">import</span> <span class="n">decodingCurveSupervised</span>
    <span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">get_dataset</span>
    
    <span class="n">loadfn</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">dataroot</span> <span class="o">=</span> <span class="n">get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">==</span><span class="s1">&#39;toy&#39;</span><span class="p">:</span>
        <span class="n">loader_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">isi</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">noise2signal</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">nTrl</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">nSamp</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="n">loadfn</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">loader_args</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;fs&#39;</span><span class="p">]</span>
    <span class="n">ch_names</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>

    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># (nsamp, nY)</span>
        
    <span class="c1"># raw</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">3</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">evtlabs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;re&#39;</span><span class="p">,</span> <span class="s1">&#39;fe&#39;</span><span class="p">,</span> <span class="s1">&#39;rest&#39;</span><span class="p">)</span><span class="c1">#  (&#39;re&#39;, &#39;ntre&#39;)#  (&#39;re&#39;, &#39;ntre&#39;, &#39;rest&#39;)#  (&#39;1&#39;, &#39;0&#39;)#</span>
    <span class="n">cca</span> <span class="o">=</span> <span class="n">MultiCCA</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cca = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cca</span><span class="p">))</span>
    <span class="n">cca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">cca</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;score=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cca</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)))</span>
    <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span>

    <span class="c1"># cca - cv-fit</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CV fitted&quot;</span><span class="p">)</span>
    <span class="n">cca</span> <span class="o">=</span> <span class="n">MultiCCA</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">)</span>
    <span class="n">cv_res</span> <span class="o">=</span> <span class="n">cca</span><span class="o">.</span><span class="n">cv_fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">cv_res</span><span class="p">[</span><span class="s1">&#39;estimator&#39;</span><span class="p">]</span>
    <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">,</span><span class="n">priorsigma</span><span class="o">=</span><span class="p">(</span><span class="n">cca</span><span class="o">.</span><span class="n">sigma0_</span><span class="p">,</span><span class="n">cca</span><span class="o">.</span><span class="n">priorweight</span><span class="p">))</span>
        
    <span class="kn">from</span> <span class="nn">model_fitting</span> <span class="kn">import</span> <span class="n">MultiCCA</span><span class="p">,</span> <span class="n">FwdLinearRegression</span><span class="p">,</span> <span class="n">BwdLinearRegression</span>
    <span class="kn">from</span> <span class="nn">updateSummaryStatistics</span> <span class="kn">import</span> <span class="n">updateSummaryStatistics</span><span class="p">,</span> <span class="n">plot_erp</span><span class="p">,</span> <span class="n">plot_summary_statistics</span>
    <span class="kn">from</span> <span class="nn">scoreStimulus</span> <span class="kn">import</span> <span class="n">factored2full</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span>  <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">decodingCurveSupervised</span> <span class="kn">import</span> <span class="n">decodingCurveSupervised</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">3</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">evtlabs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;re&#39;</span><span class="p">,</span> <span class="s1">&#39;fe&#39;</span><span class="p">,</span> <span class="s1">&#39;rest&#39;</span><span class="p">)</span> <span class="c1">#(&#39;re&#39;, &#39;ntre&#39;) # (&#39;re&#39;, &#39;fe&#39;)  # (&#39;1&#39;, &#39;0&#39;) #</span>
    <span class="c1"># cca</span>
    <span class="n">cca</span> <span class="o">=</span> <span class="n">MultiCCA</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cca</span><span class="p">))</span>
    <span class="n">cca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">cca</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span>

    <span class="n">plot_erp</span><span class="p">(</span><span class="n">factored2full</span><span class="p">(</span><span class="n">cca</span><span class="o">.</span><span class="n">W_</span><span class="p">,</span> <span class="n">cca</span><span class="o">.</span><span class="n">R_</span><span class="p">),</span> <span class="n">ch_names</span><span class="o">=</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;W_cca.png&#39;</span><span class="p">)</span>
    
    <span class="c1"># fwd-model</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Forward Model&quot;</span><span class="p">)</span>
    <span class="n">fwd</span> <span class="o">=</span> <span class="n">FwdLinearRegression</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">badEpThresh</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fwd</span><span class="p">))</span>
    <span class="n">fwd</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">fwd</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span>
    
    <span class="c1"># bwd-model</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backward Model&quot;</span><span class="p">)</span>
    <span class="n">bwd</span> <span class="o">=</span> <span class="n">BwdLinearRegression</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">badEpThresh</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bwd</span><span class="p">))</span>
    <span class="n">bwd</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">bwd</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span>

    <span class="n">Py</span> <span class="o">=</span> <span class="n">bwd</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">visualize_Fy_Py</span><span class="p">(</span><span class="n">Fy</span><span class="p">,</span> <span class="n">Py</span><span class="p">)</span>

    <span class="c1"># sklearn wrapper</span>
    <span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span><span class="p">,</span> <span class="n">LogisticRegression</span>
    <span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">LinearSVR</span><span class="p">,</span> <span class="n">LinearSVC</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sklearn-ridge&quot;</span><span class="p">)</span>
    <span class="n">ridge</span> <span class="o">=</span> <span class="n">LinearSklearn</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">clsfr</span><span class="o">=</span><span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ridge</span><span class="p">))</span>
    <span class="n">ridge</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">ridge</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sklear-lr&quot;</span><span class="p">)</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">LinearSklearn</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">clsfr</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;multinomial&#39;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;sag&#39;</span><span class="p">),</span> <span class="n">labelizeY</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>
    <span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sklear-svc&quot;</span><span class="p">)</span>
    <span class="n">svc</span> <span class="o">=</span> <span class="n">LinearSklearn</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">,</span> <span class="n">clsfr</span><span class="o">=</span><span class="n">LinearSVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">),</span> <span class="n">labelizeY</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">svc</span><span class="p">))</span>
    <span class="n">svc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">svc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dedup0</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span>

    
    <span class="n">plot_erp</span><span class="p">(</span><span class="n">factored2full</span><span class="p">(</span><span class="n">svc</span><span class="o">.</span><span class="n">W_</span><span class="p">,</span> <span class="n">svc</span><span class="o">.</span><span class="n">R_</span><span class="p">),</span> <span class="n">ch_names</span><span class="o">=</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">evtlabs</span><span class="o">=</span><span class="n">evtlabs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;W_svc.png&#39;</span><span class="p">)</span>

    
    <span class="c1"># hyper-parameter optimization with cross-validation</span>
    <span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
    <span class="n">tuned_parameters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rank&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="s1">&#39;tau&#39;</span><span class="p">:[</span><span class="nb">int</span><span class="p">(</span><span class="n">dur</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span> <span class="k">for</span> <span class="n">dur</span> <span class="ow">in</span> <span class="p">[</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="o">.</span><span class="mi">3</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">7</span><span class="p">]],</span> <span class="s1">&#39;evtlabs&#39;</span><span class="p">:[[</span><span class="s1">&#39;re&#39;</span><span class="p">,</span> <span class="s1">&#39;fe&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;re&#39;</span><span class="p">,</span> <span class="s1">&#39;ntre&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">]]}</span>
    <span class="n">cv_cca</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">MultiCCA</span><span class="p">(),</span> <span class="n">tuned_parameters</span><span class="p">)</span>
    <span class="n">cv_cca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CVOPT:</span><span class="se">\n\n</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cv_cca</span><span class="o">.</span><span class="n">best_estimator_</span><span class="p">,</span> <span class="n">cv_cca</span><span class="o">.</span><span class="n">best_score_</span><span class="p">))</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">cv_cca</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;mean_test_score&#39;</span><span class="p">]</span>
    <span class="n">stds</span> <span class="o">=</span> <span class="n">cv_cca</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;std_test_score&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">cv_cca</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:5.3f}</span><span class="s2"> (+/-</span><span class="si">{:5.3f}</span><span class="s2">) for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># use the best setting to fit a normal model, and get it&#39;s cv estimated predictions</span>
    <span class="n">cca</span> <span class="o">=</span> <span class="n">MultiCCA</span><span class="p">()</span>
    <span class="n">cca</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">cv_cca</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span> <span class="c1"># Note: **dict -&gt; k,v argument array</span>
    <span class="n">cv_res</span> <span class="o">=</span> <span class="n">cca</span><span class="o">.</span><span class="n">cv_fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">cv_res</span><span class="p">[</span><span class="s1">&#39;estimator&#39;</span><span class="p">]</span>
    <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span>
    
    <span class="c1"># Slice data</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">sliceData</span><span class="p">,</span> <span class="n">sliceY</span>
    <span class="n">stimTimes</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="n">st</span> <span class="o">&lt;</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tau</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># limit valid stimTimes</span>
    <span class="n">Xe</span> <span class="o">=</span> <span class="n">sliceData</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">stimTimes</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span> <span class="c1"># d x tau x ep x trl</span>
    <span class="n">Ye</span> <span class="o">=</span> <span class="n">sliceY</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">stimTimes</span><span class="p">,</span> <span class="n">featdim</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># y x ep  x trl</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cca = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cca</span><span class="p">))</span>
    <span class="n">Fy</span> <span class="o">=</span> <span class="n">cca</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fy=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Fy</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">Py</span> <span class="o">=</span> <span class="n">cca</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Py=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Py</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">cca</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;score=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
    <span class="n">decodingCurveSupervised</span><span class="p">(</span><span class="n">Fy</span><span class="p">)</span></div>
    
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span>  <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">testcase</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Mark van Kesteren

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>